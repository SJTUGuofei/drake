function testAtlasWallStepping()
robot = RigidBodyManipulator([getDrakePath,'/examples/Atlas/urdf/atlas_minimal_contact.urdf'],struct('floating',true));
% add a wall
l_wall_pos = [0.5;0.9;1];
r_wall_pos = [0.5;-0.9;1];
wall_size = [2;0.1;2];
l_wall = RigidBodyBox(wall_size,l_wall_pos,[0;0;0]);
r_wall = RigidBodyBox(wall_size,r_wall_pos,[0;0;0]);
robot = robot.addGeometryToBody(1,l_wall);
robot = robot.addGeometryToBody(1,r_wall);
trap_size = [0.5;1;0.05];
trap_pos = [0.5;0;0];
ground_pos1 = [(trap_pos(1)-trap_size(1)/2+(l_wall_pos(1)-wall_size(1)/2))/2;0;-0.05];
ground_size1 = [(trap_pos(1)-trap_size(1)/2-(l_wall_pos(1)-wall_size(1)/2));l_wall_pos(2)-r_wall_pos(2)+wall_size(2);0.1];
ground1 = RigidBodyBox(ground_size1,ground_pos1,zeros(3,1));
robot = robot.addGeometryToBody(1,ground1);
ground_pos2 = [trap_pos(1);(trap_pos(2)+trap_size(2)/2+l_wall_pos(2)+wall_size(2)/2)/2;-0.05];
ground_size2 = [trap_size(1);(l_wall_pos(2)+wall_size(2)/2-(trap_pos(2)+trap_size(2)/2));0.1];
ground2 = RigidBodyBox(ground_size2,ground_pos2,zeros(3,1));
robot = robot.addGeometryToBody(1,ground2);
ground_pos3 = [trap_pos(1);(trap_pos(2)-trap_size(2)/2+r_wall_pos(2)-wall_size(2)/2)/2;-0.05];
ground_size3 = [trap_size(1);trap_pos(2)-trap_size(2)/2-(r_wall_pos(2)-wall_size(2)/2);0.1];
ground3 = RigidBodyBox(ground_size3,ground_pos3,zeros(3,1));
robot = robot.addGeometryToBody(1,ground3);
ground_pos4 = [(trap_pos(1)+trap_size(1)/2+l_wall_pos(1)+wall_size(1)/2)/2;0;-0.05];
ground_size4 = [l_wall_pos(1)+wall_size(1)/2-((trap_pos(1)+trap_size(1)/2));l_wall_pos(2)-r_wall_pos(2)+wall_size(2);0.1];
ground4 = RigidBodyBox(ground_size4,ground_pos4,zeros(3,1));
robot = robot.addGeometryToBody(1,ground4);
robot = robot.compile();
v = robot.constructVisualizer();
nq = robot.getNumPositions();
nv = robot.getNumVelocities();
l_foot = robot.findLinkId('l_foot');
r_foot = robot.findLinkId('r_foot');
l_toe = robot.getBody(l_foot).getTerrainContactPoints('toe');
l_heel = robot.getBody(l_foot).getTerrainContactPoints('heel');
l_foot_contact_pts = [l_toe l_heel];
l_foot_outer_edge = [l_toe(:,1) l_heel(:,1)];
l_foot_center = mean(l_foot_contact_pts,2);
r_toe = robot.getBody(r_foot).getTerrainContactPoints('toe');
r_heel = robot.getBody(r_foot).getTerrainContactPoints('heel');
r_foot_contact_pts = [r_toe r_heel];
r_foot_outer_edge = [r_toe(:,2) r_heel(:,2)];
r_foot_center = mean(r_foot_contact_pts,2);
r_hand = robot.findLinkId('r_hand');
l_hand = robot.findLinkId('l_hand');
rhand_pt = [0;-0.15;0];
lhand_pt = [0;-0.15;0];
rhand_dir = [0;-1;0];
lhand_dir = [0;-1;0];
utorso = robot.findLinkId('utorso');

l_arm = robot.findPositionIndices('l_arm');
r_arm = robot.findPositionIndices('r_arm');
l_leg = robot.findPositionIndices('l_leg');
r_leg = robot.findPositionIndices('r_leg');
back_bkz = robot.getBody(robot.findJointId('back_bkz')).position_num;
back_bky = robot.getBody(robot.findJointId('back_bky')).position_num;
back_bkx = robot.getBody(robot.findJointId('back_bkx')).position_num;
l_arm_shz = robot.getBody(robot.findJointId('l_arm_shz')).position_num;
l_leg_hpz = robot.getBody(robot.findJointId('l_leg_hpz')).position_num;
l_leg_hpx = robot.getBody(robot.findJointId('l_leg_hpx')).position_num;
l_leg_hpy = robot.getBody(robot.findJointId('l_leg_hpy')).position_num;
l_leg_kny = robot.getBody(robot.findJointId('l_leg_kny')).position_num;
l_leg_aky = robot.getBody(robot.findJointId('l_leg_aky')).position_num;
l_leg_akx = robot.getBody(robot.findJointId('l_leg_akx')).position_num;
l_arm_shx = robot.getBody(robot.findJointId('l_arm_shx')).position_num;
l_arm_ely = robot.getBody(robot.findJointId('l_arm_ely')).position_num;
l_arm_elx = robot.getBody(robot.findJointId('l_arm_elx')).position_num;
l_arm_uwy = robot.getBody(robot.findJointId('l_arm_uwy')).position_num;
l_arm_mwx = robot.getBody(robot.findJointId('l_arm_mwx')).position_num;
l_arm_lwy = robot.getBody(robot.findJointId('l_arm_lwy')).position_num;
r_arm_shz = robot.getBody(robot.findJointId('r_arm_shz')).position_num;
r_leg_hpz = robot.getBody(robot.findJointId('r_leg_hpz')).position_num;
r_leg_hpx = robot.getBody(robot.findJointId('r_leg_hpx')).position_num;
r_leg_hpy = robot.getBody(robot.findJointId('r_leg_hpy')).position_num;
r_leg_kny = robot.getBody(robot.findJointId('r_leg_kny')).position_num;
r_leg_aky = robot.getBody(robot.findJointId('r_leg_aky')).position_num;
r_leg_akx = robot.getBody(robot.findJointId('r_leg_akx')).position_num;
r_arm_shx = robot.getBody(robot.findJointId('r_arm_shx')).position_num;
r_arm_ely = robot.getBody(robot.findJointId('r_arm_ely')).position_num;
r_arm_elx = robot.getBody(robot.findJointId('r_arm_elx')).position_num;
r_arm_uwy = robot.getBody(robot.findJointId('r_arm_uwy')).position_num;
r_arm_mwx = robot.getBody(robot.findJointId('r_arm_mwx')).position_num;
r_arm_lwy = robot.getBody(robot.findJointId('r_arm_lwy')).position_num;
neck_ay = robot.getBody(robot.findJointId('neck_ay')).position_num;
% find an initial posture
xstar = load([getDrakePath,'/examples/Atlas/data/atlas_fp.mat']);
xstar = xstar.xstar;
qstar = xstar(1:nq);
qstar(l_arm_shx) = -1;
qstar(l_arm_elx) = 1;
qstar(r_arm_shx) = 1;
qstar(r_arm_elx) = -1;
lfoot_on_ground0 = WorldPositionConstraint(robot,l_foot,l_foot_contact_pts,[nan(1,4);zeros(1,4);zeros(1,4)],[(trap_pos(1)-trap_size(1)/2-0.05)*ones(1,4);nan(1,4);zeros(1,4)]);
rfoot_on_ground0 = WorldPositionConstraint(robot,r_foot,r_foot_contact_pts,[nan(2,4);zeros(1,4)],[(trap_pos(1)-trap_size(1)/2-0.05)*ones(1,4);-0.05*ones(1,4);zeros(1,4)]);
lhand_on_wall = WorldPositionConstraint(robot,l_hand,lhand_pt,[trap_pos(1)-trap_size(1)/2+0.3;l_wall_pos(2)-wall_size(2)/2;1.4],[l_wall_pos(1)+wall_size(1)/2;l_wall_pos(2)-wall_size(2)/2;nan]);
lhand_dir0 = WorldGazeDirConstraint(robot,l_hand,lhand_dir,[0;1;0],pi/2.3);
rhand_on_wall = WorldPositionConstraint(robot,r_hand,rhand_pt,[trap_pos(1)-trap_size(1)/2+0.3;r_wall_pos(2)+wall_size(2)/2;1.4],[r_wall_pos(1)+wall_size(1)/2;r_wall_pos(2)+wall_size(2)/2;nan]);
rhand_dir0 = WorldGazeDirConstraint(robot,l_hand,rhand_dir,[0;-1;0],pi/2.3);
utorso_upright0 = WorldGazeDirConstraint(robot,utorso,[0;0;1],[0;0;1],pi/6);
ik = InverseKinematics(robot,qstar,lfoot_on_ground0,rfoot_on_ground0,lhand_on_wall,utorso_upright0,rhand_on_wall);
[q0,F,info] = ik.solve(qstar);
kinsol0 = robot.doKinematics(q0);
rhand_pos0 = robot.forwardKin(kinsol0,r_hand,rhand_pt,2);
lhand_pos0 = robot.forwardKin(kinsol0,l_hand,lhand_pt,2);
rfoot_pos0 = robot.forwardKin(kinsol0,r_foot,r_foot_center,2);
lfoot_pos0 = robot.forwardKin(kinsol0,l_foot,l_foot_center,2);
com0 = robot.getCOM(kinsol0);

% find the end posture
lfoot_on_ground2 = WorldPositionConstraint(robot,l_foot,l_foot_contact_pts,[(trap_pos(1)+trap_size(1)/2+0.03)*ones(1,4);zeros(1,4);zeros(1,4)],[nan(2,4);zeros(1,4)]);
rfoot_on_ground2 = WorldPositionConstraint(robot,r_foot,r_foot_contact_pts,[(trap_pos(1)+trap_size(1)/2+0.03)*ones(1,4);nan(1,4);zeros(1,4)],[nan(1,4);zeros(1,4);zeros(1,4)]);
lhand_pos_cnstr = WorldPositionConstraint(robot,l_hand,lhand_pt,lhand_pos0(1:3),lhand_pos0(1:3));
rhand_pos_cnstr = WorldPositionConstraint(robot,r_hand,rhand_pt,rhand_pos0(1:3),rhand_pos0(1:3));
utorso_upright2 = WorldGazeDirConstraint(robot,utorso,[0;0;1],[0;0;1],pi/10);
ik = InverseKinematics(robot,qstar,lfoot_on_ground2,rfoot_on_ground2,lhand_pos_cnstr,rhand_pos_cnstr,utorso_upright2);
ik = ik.addConstraint(BoundingBoxConstraint(trap_pos(1)+trap_size(1)/2+0.05,inf),ik.q_idx(1));
[q2,F,info] = ik.solve(q0);
kinsol2 = robot.doKinematics(q2);
lfoot_pos2 = robot.forwardKin(kinsol2,l_foot,l_foot_center,2);
rfoot_pos2 = robot.forwardKin(kinsol2,r_foot,r_foot_center,2);
com2 = robot.getCOM(kinsol2);

lfoot_on_ground1 = WorldPositionConstraint(robot,l_foot,l_foot_contact_pts,repmat([(trap_pos(1)-trap_size(1)/2);(trap_pos(2)+trap_size(2)/2+0.01);0],1,4),repmat([(trap_pos(1)+trap_size(1)/2);(l_wall_pos(2)-wall_size(2)/2);0],1,4));
rfoot_on_ground1 = WorldPositionConstraint(robot,r_foot,r_foot_contact_pts,repmat([(trap_pos(1)-trap_size(1)/2);(r_wall_pos(2)+wall_size(2)/2);0],1,4),repmat([(trap_pos(1)+trap_size(1)/2);(trap_pos(2)-trap_size(2)/2-0.03);0],1,4));
utorso_upright1 = WorldGazeDirConstraint(robot,utorso,[0;0;1],[0;0;1],pi/10);
ik = InverseKinematics(robot,qstar,lfoot_on_ground1,rfoot_on_ground1,lhand_pos_cnstr,rhand_pos_cnstr,utorso_upright1);
[q1,F,info] = ik.solve(q0);
kinsol1 = robot.doKinematics(q1);
lfoot_pos1 = robot.forwardKin(kinsol1,l_foot,l_foot_center,2);
rfoot_pos1 = robot.forwardKin(kinsol1,r_foot,r_foot_center,2);

num_ground_fc_edges = 4;
num_wall_fc_edges = 3;
ground_mu = 1;
wall_mu = 2;
ground_fc_theta = linspace(0,2*pi,num_ground_fc_edges+1);
ground_fc_theta = ground_fc_theta(1:end-1);
wall_fc_theta = linspace(0,2*pi,num_wall_fc_edges+1);
wall_fc_theta = wall_fc_theta(1:end-1);
ground_fc = [cos(ground_fc_theta)*ground_mu;sin(ground_fc_theta)*ground_mu;ones(1,num_ground_fc_edges)];
lwall_fc = rotateVectorToAlign([0;0;1],[0;-1;0])*[cos(wall_fc_theta)*wall_mu;sin(wall_fc_theta)*wall_mu;ones(1,num_wall_fc_edges)];
rwall_fc = rotateVectorToAlign([0;0;1],[0;1;0])*[cos(wall_fc_theta)*wall_mu;sin(wall_fc_theta)*wall_mu;ones(1,num_wall_fc_edges)];
lhand_force_max = 400;
rhand_force_max = 400;

rfoot_takeoff0 = 2;
rfoot_land0 = 4;
lfoot_takeoff0 = 5;
lfoot_land0 = 7;
rfoot_takeoff1 = 8;
rfoot_land1 = 10;
lfoot_takeoff1 = 11;
lfoot_land1 = 13;
hand_off = 14;
nT = 15;

lfoot_cw = LinearFrictionConeWrench(robot,l_foot,l_foot_center,ground_fc);
rfoot_cw = LinearFrictionConeWrench(robot,r_foot,r_foot_center,ground_fc);
lhand_cw = GraspWrenchPolytope(robot,l_hand,lhand_pt,lhand_force_max*[zeros(6,1) [lwall_fc;zeros(3,num_wall_fc_edges)]]);
rhand_cw = GraspWrenchPolytope(robot,r_hand,rhand_pt,rhand_force_max*[zeros(6,1) [rwall_fc;zeros(3,num_wall_fc_edges)]]);

lfoot_contact_wrench0 = struct('active_knot',1:lfoot_takeoff0-1,'cw',lfoot_cw,'contact_pos',lfoot_pos0(1:3));
rfoot_contact_wrench0 = struct('active_knot',1:rfoot_takeoff0-1,'cw',rfoot_cw,'contact_pos',rfoot_pos0(1:3));
lfoot_contact_wrench1 = struct('active_knot',lfoot_land0:lfoot_takeoff1-1,'cw',lfoot_cw,'contact_pos',lfoot_pos1(1:3));
rfoot_contact_wrench1 = struct('active_knot',rfoot_land0:rfoot_takeoff1-1,'cw',rfoot_cw,'contact_pos',rfoot_pos1(1:3));
lfoot_contact_wrench2 = struct('active_knot',lfoot_land1:nT,'cw',lfoot_cw,'contact_pos',lfoot_pos2(1:3));
rfoot_contact_wrench2 = struct('active_knot',rfoot_land1:nT,'cw',rfoot_cw,'contact_pos',rfoot_pos2(1:3));
lhand_contact_wrench = struct('active_knot',1:hand_off-1,'cw',lhand_cw,'contact_pos',lhand_pos0(1:3));
rhand_contact_wrench = struct('active_knot',1:hand_off-1,'cw',rhand_cw,'contact_pos',rhand_pos0(1:3));

Q_comddot = eye(3);
Qv = 0.1*ones(nv,1);
Qv = diag(Qv);
Q = eye(nq);
Q(1,1) = 0;
Q(2,2) = 0;
Q(5,5) = 10;
Q(6,6) = 10;
T_lb = 2;
T_ub = 3;
tf_range = [T_lb T_ub];

cws_margin_cost = 10;
q_nom = repmat(q0,1,nT);
contact_wrench_struct = [lfoot_contact_wrench0 rfoot_contact_wrench0 lfoot_contact_wrench1 rfoot_contact_wrench1 lfoot_contact_wrench2 rfoot_contact_wrench2 lhand_contact_wrench rhand_contact_wrench];

disturbance_pos = repmat(com0,1,nT)+bsxfun(@times,(0:nT-1),(com2-com0)/(nT-1));
Qw = eye(6);
fccdfkp_options = struct();
fccdfkp = FixedContactsFixedDisturbanceComDynamicsFullKinematicsPlanner(robot,nT,tf_range,Q_comddot,Qv,Q,cws_margin_cost,q_nom,contact_wrench_struct,Qw,disturbance_pos,fccdfkp_options);
end